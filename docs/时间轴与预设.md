# 时间轴与预设

本文档说明时间轴状态结构、插值与吸附行为，以及预设的存储策略与按名称加载/保存方式。

---

## 时间轴

### 状态结构

- **TimelineState**：`currentTime`、`playing`、`duration`、`frameStep`、`tracks`。
- **TimelineTrack**：`id`、`paramKey`（参数键名）、`label`、`keyframes`、`interpolation`（`"linear"` | `"step"`）。
- **Keyframe**：`t`（时间，秒）、`value`（number | string | boolean，如颜色为 `#rrggbb` 字符串）。

### 插值

- 数字、颜色（`#rrggbb`）：线性插值。
- 布尔、非颜色字符串：步进（按前后关键帧时间取其一）。
- 轨道无关键帧时，采样结果为参数当前值，该参数会视为「已改变」，便于用户点击「添加关键帧」。

### 吸附

- 工具栏「吸附」可选：无、1、0.5、0.1。
- 对 `setTime` 与播放头拖拽生效：时间会四舍五入到对应网格（如 0.5 表示吸附到 0、0.5、1.0…）。

### onStateChange

- `createTimeline` 的 `onStateChange` 在 setTime、addTrack、removeTrack、updateTrack 时被调用。
- 可用于防抖后把当前 `getState()` 写入预设（例如保存到当前预设名称），实现「改时间轴就自动保存」的逻辑。

---

## 预设

### 存储策略

- **加载**：页面初始化时优先请求 `/presets.json`（对应项目内 `public/presets.json`）。若请求成功则用返回的 JSON 作为预设列表（并同步到 localStorage）；若失败（如 404）则使用 localStorage 中已有的数据。
- **保存**：每次 `savePreset`、`saveAsNewPreset`、`renamePreset` 都会更新内存与 localStorage，并在开发环境下 POST 到 `/api/presets`，将完整 PresetsData 写入 `public/presets.json`。

### 按名称加载 / 保存

- **加载**：根据「当前输入的名称」在 `getPresets()` 中查找 `name` 相等的预设，取到后调用 `timeline.loadState(preset.state)`。未找到可提示用户。
- **保存**：根据「当前输入的名称」查找同名预设；若存在则 `savePreset(id, timeline.getState())`，否则 `saveAsNewPreset(name, timeline.getState())`。重命名即：在输入框中改为新名称后执行保存（相当于另存为新名）。

### 预设文件与开发环境 API

文件位置、POST 约定及生产环境行为见 [预设文件与 API](预设文件与API.md)。
